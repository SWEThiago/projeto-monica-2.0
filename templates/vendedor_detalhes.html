{% extends 'base.html' %}

{% block content %}
<div class="vendedor-detalhes-container">
    <h2>Detalhes do Vendedor: {{ vendedor.nome }}</h2>

    <div class="leads-info">
        <p>Total de Leads: {{ total_leads }}</p>
        <p>Leads Abertos: {{ quantidade_aberto }} ({{ (quantidade_aberto / total_leads) * 100 if total_leads > 0 else 0 }}%)</p>
        <p>Leads Convertidos: {{ quantidade_convertido }} ({{ (quantidade_convertido / total_leads) * 100 if total_leads > 0 else 0 }}%)</p>
        <p>Leads Perdidos: {{ quantidade_perdido }} ({{ (quantidade_perdido / total_leads) * 100 if total_leads > 0 else 0 }}%)</p>
    </div>

    <h3>Leads Atribuídos</h3>
    <table class="table-leads">
        <thead>
            <tr>
                <th>Data do Lead</th>
                <th>Nome do Lead</th>
                <th>Veículo</th>
                <th>Modelo</th>
                <th>Status</th>
                <th>Faturado</th>
                <th>Cliente Faturado</th>
                <th>Nota Fiscal</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads %}
            <tr>
                <form method="POST" action="{{ url_for('atualizar_lead', vendedor_id=vendedor.id) }}">
                    <input type="hidden" name="lead_id" value="{{ lead.id }}">
                    <td>{{ lead.data_lead.strftime('%d/%m/%y') }}</td>
                    <td>{{ lead.nome }}</td>
                    <td>{{ lead.veiculo }}</td>
                    <td>{{ lead.modelo }}</td>
                    <td>
                        <select name="status_{{ lead.id }}">
                            <option value="Aberto" {% if lead.status == 'Aberto' %}selected{% endif %}>Aberto</option>
                            <option value="Convertido" {% if lead.status == 'Convertido' %}selected{% endif %}>Convertido</option>
                            <option value="Perdido" {% if lead.status == 'Perdido' %}selected{% endif %}>Perdido</option>
                        </select>
                    </td>
                    <td>
                        <select name="faturado_{{ lead.id }}">
                            <option value="Sim" {% if lead.faturado == 'Sim' %}selected{% endif %}>Sim</option>
                            <option value="Nao" {% if lead.faturado == 'Nao' %}selected{% endif %}>Não</option>
                        </select>
                    </td>
                    <td>
                        <input type="text" name="cliente_faturado_{{ lead.id }}" value="{{ lead.cliente_faturado }}" placeholder="Nome do Cliente">
                    </td>
                    <td>
                        <input type="text" name="nota_fiscal_{{ lead.id }}" value="{{ lead.nota_fiscal }}" placeholder="Nota Fiscal">
                    </td>
                    <td>
                        <button type="submit" class="botao-salvar">Salvar</button>
                    </td>
                </form>
                <td>
                    <form method="POST" action="{{ url_for('remover_lead', vendedor_id=vendedor.id, lead_id=lead.id) }}">
                        <button type="submit" class="botao-remover">Remover</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9">Nenhum lead encontrado.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3>Desempenho do Vendedor</h3>
    <div class="grafico-performance-container">
        <canvas id="graficoPerformanceVendedor"></canvas>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const totalLeads = {{ total_leads }};
        const ctx = document.getElementById('graficoPerformanceVendedor').getContext('2d');

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Abertos', 'Convertidos', 'Perdidos'],
                datasets: [{
                    label: 'Leads',
                    data: [{{ quantidade_aberto }}, {{ quantidade_convertido }}, {{ quantidade_perdido }}],
                    backgroundColor: ['#FFCE56', '#4CAF50', '#F7464A'],
                    borderColor: ['#FFCE56', '#4CAF50', '#F7464A'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                const valor = tooltipItem.raw;
                                const porcentagem = (valor / totalLeads * 100).toFixed(2);
                                return `${valor} Leads (${porcentagem}%)`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Status dos Leads'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Quantidade de Leads'
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
